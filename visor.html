<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisorVB - Punta Chullera</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        #visorvb {
            width: 100%;
            height: 600px; /* Altura fija, ajustable según necesidades */
        }
        .vbvisor-control-tools {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
        }
        .vbvisor-control-tools button {
            display: block;
            width: 100%;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .vbvisor-control-tools .panel {
            display: none;
            min-height: 50px; /* Asegura que el panel tenga un tamaño mínimo */
            min-width: 150px; /* Asegura que el panel sea visible */
            background-color: white;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .vbvisor-control-coords {
            background-color: white;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            display: none; /* Inicialmente oculto, visible con tecla 'C' */
        }
        .vbvisor-control-nav-circle {
            position: relative;
            width: 100px;
            height: 100px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .vbvisor-control-nav-circle button {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .vbvisor-control-nav-circle button:hover {
            background-color: #353157aa;
            color:white
        }
        .vbvisor-control-nav-circle .center-btn {
            width: 40px;
            height: 40px;
        }
        .vbvisor-control-nav-circle .up-btn { top: 0px; }
        .vbvisor-control-nav-circle .down-btn { bottom: 0px; }
        .vbvisor-control-nav-circle .left-btn { left: 0px; }
        .vbvisor-control-nav-circle .right-btn { right: 0px; }
        .vbvisor-popup {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        }
        .vbvisor-popup .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="visorvb"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-kml@latest/L.KML.js"></script>
    <script>
        // Configuración del mapa
        const mapConfig = {
            initialLat: 36.3217, // Latitud inicial (La Paloma 10, Punta Chullera)
            initialLng: -5.2489, // Longitud inicial
            initialZoom: 17, // Nivel de zoom inicial
            centerLat: 36.3217, // Latitud para centrar el mapa
            centerLng: -5.2489, // Longitud para centrar el mapa
            wmsLayers: [
                {
                    url: 'https://www.ign.es/wms-inspire/pnoa-ma?',
                    layers: 'OI.OrthoimageCoverage',
                    format: 'image/jpeg',
                    transparent: true,
                    opacity: 1.0,
                    attribution: 'Visor desarrollado por VerticeB con la tecnologia de Leaflet | © Instituto Geográfico Nacional de España'
                }
            ],
            kmlFiles: [
                'LaPaloma10.kml'
            ],
            kmlPopupContent: function(feature) {
                // Personaliza el contenido del popup aquí
                const name = feature.properties.name || 'Sin nombre';
                const description = feature.properties.description || 'Sin descripción';
                return `
                    <h3>${name}</h3>
                    <p>${description}</p>
                    <p>Coordenadas: ${feature.geometry.coordinates || 'No disponibles'}</p>
                `;
            }
        };

        // Inicializar el mapa
        var map = L.map('visorvb', {
            attributionControl: true
        }).setView([mapConfig.initialLat, mapConfig.initialLng], mapConfig.initialZoom);

        map.attributionControl.setPrefix(false);

        // Configurar las capas WMS
        mapConfig.wmsLayers.forEach(layerConfig => {
            L.tileLayer.wms(layerConfig.url, {
                layers: layerConfig.layers,
                format: layerConfig.format,
                transparent: layerConfig.transparent,
                opacity: layerConfig.opacity,
                attribution: layerConfig.attribution
            }).addTo(map);
        });

        // Control personalizado para popup
        L.Control.Popup = L.Control.extend({
            options: { position: 'topleft' }, // Posición inicial, se ajustará dinámicamente
            onAdd: function(map) {
                this._div = L.DomUtil.create('div', 'vbvisor-popup');
                this._div.style.display = 'none';
                L.DomEvent.disableClickPropagation(this._div);
                return this._div;
            },
            show: function(content, latlng) {
                this._div.innerHTML = content + '<span class="close-btn">✖</span>';
                this._div.style.display = 'block';
                const point = map.latLngToContainerPoint(latlng);
                this._div.style.left = point.x + 10 + 'px';
                this._div.style.top = point.y + 10 + 'px';
                const closeBtn = this._div.querySelector('.close-btn');
                closeBtn.onclick = () => this.hide();
            },
            hide: function() {
                this._div.style.display = 'none';
            }
        });

        const popupControl = new L.Control.Popup().addTo(map);

        // Cargar archivos KML
        if (mapConfig.kmlFiles && mapConfig.kmlFiles.length > 0) {
            mapConfig.kmlFiles.forEach(kmlUrl => {
                if (!kmlUrl) {
                    console.error('Error: URL de KML vacía o no válida');
                    return;
                }
                fetch(kmlUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`No se pudo cargar el archivo KML: ${kmlUrl} (Estado: ${response.status})`);
                        }
                        return response.text();
                    })
                    .then(kmlText => {
                        const parser = new DOMParser();
                        const kml = parser.parseFromString(kmlText, 'text/xml');
                        const kmlLayer = new L.KML(kml);
                        kmlLayer.on('click', function(e) {
                            const feature = e.layer.feature;
                            const latlng = e.latlng || (e.layer.getBounds ? e.layer.getBounds().getCenter() : null);
                            if (feature && latlng) {
                                const content = mapConfig.kmlPopupContent(feature);
                                popupControl.show(content, latlng);
                            }
                        });
                        map.addLayer(kmlLayer);
                    })
                    .catch(error => console.error(`Error cargando KML desde ${kmlUrl}:`, error.message));
            });
        } else {
            console.warn('No se especificaron archivos KML en mapConfig.kmlFiles');
        }

        // Ajustar el mapa al contenedor
        map.invalidateSize();

        // Control personalizado para herramientas desplegables (en topright)
        L.Control.Tools = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'vbvisor-control-tools');
                var toggleBtn = L.DomUtil.create('button', 'toggle', container);
                toggleBtn.innerHTML = '<i class="fas fa-tools"></i>';
                toggleBtn.title = 'Herramientas';
                var panel = L.DomUtil.create('div', 'panel', container);

                // Botón de ejemplo para verificar funcionalidad
                var exampleBtn = L.DomUtil.create('button', '', panel);
                exampleBtn.innerHTML = '<i class="fas fa-info-circle"></i> Ejemplo';
                exampleBtn.onclick = function () {
                    alert('Botón de ejemplo en el menú de herramientas');
                };

                // Toggle para desplegar/ocultar panel
                toggleBtn.onclick = function () {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                };

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        new L.Control.Tools().addTo(map);

        // Control para coordenadas y zoom (visible con tecla 'C')
        L.Control.Coords = L.Control.extend({
            options: { position: 'bottomleft' },
            onAdd: function (map) {
                this._div = L.DomUtil.create('div', 'vbvisor-control-coords');
                this.update('Mueve el ratón', map.getZoom());
                var that = this;
                map.on('mousemove', function (e) {
                    var coords = e.latlng.lat.toFixed(4) + ', ' + e.latlng.lng.toFixed(4);
                    that.update(coords, map.getZoom());
                });
                map.on('zoomend', function () {
                    that.update(that._div.innerHTML.split(' | ')[0], map.getZoom());
                });
                return this._div;
            },
            update: function (coords, zoom) {
                this._div.innerHTML = 'Coordenadas: ' + coords + ' | Zoom: ' + zoom;
            }
        });

        var coordsControl = new L.Control.Coords().addTo(map);

        // Mostrar/ocultar coordenadas con tecla 'C'
        document.addEventListener('keydown', function (e) {
            if (e.key === 'c' || e.key === 'C') {
                coordsControl._div.style.display = coordsControl._div.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Control para navegación circular (bottomright)
        L.Control.NavCircle = L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'vbvisor-control-nav-circle');

                // Botón Centrar mapa (en el centro)
                var centerBtn = L.DomUtil.create('button', 'center-btn', container);
                centerBtn.innerHTML = '<i class="fas fa-crosshairs"></i>';
                centerBtn.title = 'Centrar mapa';
                centerBtn.onclick = function () {
                    map.setView([mapConfig.centerLat, mapConfig.centerLng], mapConfig.initialZoom);
                };

                // Botones de direcciones
                var upBtn = L.DomUtil.create('button', 'up-btn', container);
                upBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                upBtn.title = 'Arriba';
                upBtn.onclick = function () {
                    map.panBy([0, -200]);
                };

                var downBtn = L.DomUtil.create('button', 'down-btn', container);
                downBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
                downBtn.title = 'Abajo';
                downBtn.onclick = function () {
                    map.panBy([0, 200]);
                };

                var leftBtn = L.DomUtil.create('button', 'left-btn', container);
                leftBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                leftBtn.title = 'Izquierda';
                leftBtn.onclick = function () {
                    map.panBy([-200, 0]);
                };

                var rightBtn = L.DomUtil.create('button', 'right-btn', container);
                rightBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                rightBtn.title = 'Derecha';
                rightBtn.onclick = function () {
                    map.panBy([200, 0]);
                };

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        new L.Control.NavCircle().addTo(map);

        // Entrada para GeoJSON de parcelas
        const parcelsGeoJSON = null;

        if (parcelsGeoJSON) {
            L.geoJSON(parcelsGeoJSON, {
                style: function (feature) {
                    return { color: 'red', weight: 2 };
                }
            }).addTo(map);
        }
    </script>
</body>
</html>